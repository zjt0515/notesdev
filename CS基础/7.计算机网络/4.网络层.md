# 网络层

1. 传输数据：分组
2. 灵活的无连接的数据报服务

- [ 小林coding](https://xiaolincoding.com/network/4_ip/ip_base.html)

> [!important]
>
> 1. 分析IP地址的类型
> 2. 根据MAC帧/IP数据报，分析首部关键字段
> 3. IP数据报分片原因和计算
> 4. ARP协议的作用和工作原理
> 5. 因特网控制报文协议ICMP和PING应用
> 6. 子网划分和地址分配
>    1. 计算子网掩码
>    2. 计算子网地址
>    3. 计算子网容纳的主机数
>    4. 计算子网的最小IP地址、最大的IP地址和广播地址
> 7. 直接交付/间接交付
> 8. 无分类编制，路由聚合，无分类编址下路由选择的最长前缀匹配原则
> 9. 

## 路由算法

路由表/转发表

| 目的网络IP地址 | 子网掩码 | 下一跳IP地址 | 接口 |
| -------------- | -------- | ------------ | ---- |
|                |          |              |      |
|                |          |              |      |
|                |          |              |      |

最佳路由：链路

## 网络层服务

1. 面向连接的虚电路服务
    1. 可靠通信由网络来保证
    2. 必须建立网络层连接——虚电路VC
    3. 沿着虚电路发送分组
    4. 连接建立阶段使用目的主机地址，之后的分组首部只需携带一条虚电路编号
    5. 通信结束，虚电路释放
    6. 配合可靠传输的网络协议，可使分组正确到达，很多广域分组交换网使用
2. 无连接的数据报服务
    1. 可靠通信由用户主机来保证
    2. 不需要建立网络层连接
    3. 每个分组可走不同的路径
    4. 每个分组首部必须携带完整主机地址
    5. 分组可能误码、丢失、重复、失序
    6. 网络本身不提供端到端的可靠传输服务，路由器可以简化、价格低
    7. 因特网采用这种设计：将复杂的网络处理功能置于因特网边缘

##  ==IPV4地址分类==

主机或路由器的每一个接口服呢配一个唯一的32比特标识符

编制方法的三个历史阶段：

1. 分类编制
2. 划分子网
3. 无分类编址

按照功能分类

1. 可分配给主机/路由器的IP
2. ABC类的私有IP
3. 特殊IP 






> [!note]
>
> ip地址表示方法：
>
> 1. 32比特: 00000000 00000000 00000000 00000000
> 2. 点分十进制：0.0.0.0(每8个比特分为一组，转化为十进制，用.分隔)

### 分类编址的IPV4

| 网络      | 网络号                                                       | 主机号(全0网络全1广播) | 默认子网掩码  |           |
| --------- | ------------------------------------------------------------ | ---------------------- | ------------- | --------- |
| A         | ==0==xxxxxxx<br />0~127<br />不可使用0<br />可指派1-126<br />回环地址127 | 2^32^-2                | 255.0.0.0     |           |
| B         | ==10==xxxxxx xxxxxxxx<br />128.0~191.255<br />不可使用128.0<br />可指派128.1~191.255 | 2^24^-2                | 255.255.0.0   |           |
| C         | ==110==xxxxx xxxxxxxx xxxxxxxx<br />192.0.0~223.255.255<br />192.0.0不可使用<br />可指派192.0.1~223.255.255 | 2^16^-2                | 255.255.255.0 |           |
| D多播地址 | ==1110==xxxxx xxxxxxxx xxxxxxxx xxxxxxxx<br />224~239        |                        |               | 用来zu'bo |
| E保留地址 | ==1111==<br />240~255                                        |                        |               |           |

1. A类： 8/24
    1. 网络号0开头
    2. 可指派的网络号（网络数量）：1~126，共126个
    4. 本地环回测试地址：127.0.0.1~127.255.255.254
2. B类：16/16
    1. 网络号10开头
    2. 可指派的网络号：128.0~191.255，共2^(16-2)^个
3. C类： 24/8
    1. 网络号110开头
    2. 可指派的网络号：192.0.0~223.255.255，共2^24-3^
4. D类：多播地址，1110
5. E类：保留地址，1111

> [!tip]
>
> 求某类网络的最大可用网络数：
> $$
> 最大可用网络数=2^{8k-k}-1(-1)\\
> 即=2^{可变网络号位数}-不可用的网络\\
> k_A=1，k_B=2,K_C=3\\
> 注：三类地址都要减去可变网络位中全0的，A类还要减去127回环地址
> $$
> 找第一个可用的网络号和最后一个可用的网络号：记住网络号有多少位，而且除了固定位不能全0
>
> 某类网络可指派的网络号由其可变的网络号比特位决定：$2^$
>
> 求某类网络可分配的IP地址：$2^{主机号位数}-2$
> 需要减去全0网络地址和全1广播地址，两个不可分配的主机地址   
>
> 1：128
> 11：192
> 111：224
> 1111：240

> [!warning]
>
> 只有ABC类地址可分配给网络主机或路由器的结果口

> [!note]
>
> 网路号和主机号
>
> - 网络号：
>
>   - 全0：保留不指派
>
>   - 全1：最大网络号，可以指派
>
> - 主机号，全0或全1不能分配
>
>   - 全0：对应网络的网络地址
>
>   - 全1：对应网络的广播地址





> [!note]
>
> 特殊IPV4地址
>
> `0.0.0.0`：只能作为源地址，表示本网络上的本主机，封装有DHCP发现报文的IP分组的源地址使用
>
> `127.0.0.1~127.255.255.254`：本地软件环回测试，既可以作为源地址使用，也可以作为目的地址使用
>
> `255.255.255.255`，即全1地址，只能作为目的地址，表示只在本网络上进行广播
>
> `0.x.x.x`：只能作为源地址，表示本网络中的某台主机

IPV4地址与指派性练习

![image-20240929154315639](./images/image-20240929154315639.png)

IPV4地址分配练习

![image-20240929160026531](./images/image-20240929160026531.png)

### 划分子网的IPV4地址

申请新网络地址，等待时间和花费费用，浪费原有网络中的的IP地址，增加其他路由器中路由表记录的数量

> [!note]
>
> 子网掩码：网络号和子网号全1，主机号全  0
> 子网掩码的1说明有多少位是网络位，0指示主机位
>
> IP地址与所在网络子网掩码相与：所在子网网络地址
> 一个网络划分的子网具有相同的子网掩码，只有当位于不同子网的IP与子网掩码相与后，才是不同的子网地址
>
> 划分子网的IPV4地址：子网掩码
>
> 1. 借用主机号的部分比特位来作为子网号，借用n个比特位，可划分出2^n^个子网
> 2. 每个子网可分配的ip地址数量为：2^k-n^-2



> [!ques]
>
> 1. 已知IP和子网掩码，求网络号/子网最多/主机最多
>    1. 网络最多能划分的子网$=2^{主机位数-2}$
>    2. 对应最小的网络的主机数：$2^2-2=2$
> 2. 已知网络号，X位子网号，求子网掩码
> 3. 已知网络号，要分成X个子网，求子网掩码和IP地址范围
> 4. 已知子网掩码，求哪些IP地址属于同一个子网

网络号.子网号.主机号

 ![image-20240929170023808](./images/image-20240929170023808.png)



![image-20240929170121794](./images/image-20240929170121794.png)

![image-20240929171406186](./images/image-20240929171406186.png)

默认的子网掩码：未划分子网的情况下使用的子网掩码

![image-20240929171600886](./images/image-20240929171600886.png)

### 无分类编址的IP地址

无分类域间路由选择CIDR：消除传统ABC类地址和划分子网概念，更加有效地分配IPV4地址空间
原本是网络号+(子网号)+主机号，变成`网络前缀+主机号`

 CIDR记法 ：`ip / [网路前缀所占的比特数量]`

将网络前缀相同的连续IP地址组成一个CIDR地址快

只要知道CIDR地址块中的一个地址，就能知道该地址块的全部细节

![image-20240929201446161](./images/image-20240929201446161.png)

==路由聚合（构造超网）==

1. 找**共同前缀**
2. 将其余位数全部取0，作为 / 的前面部分
3. 将**共同前缀的位数**放到 / 的后面部分

> [!ques]
>
> 求35.230.32.0/21、35.230.40.0/21、35.230.48.0/21、35.230.56.0/21聚合后目的网络的地址
>
> [!ans]
>
> 1. 共同前缀：35.230.32，有20位
> 2. 35.230.32/20
>
> 

> 网络前缀越长，地址块越小，路由越具体
>
> 最长前缀匹配：路由器查表转发分组时发现多条路由，选择网络前缀更长的那条

###  IPV4地址的应用规划

1. 采用定长子网掩码
    1. 子网的IP地址数量相同，地址浪费
    2. 子网数量决定了需要借用最少的比特位，也决定了每个子网的IP数量
2. 采用变长子网掩码
    1. 子网的IP地址数量可以不同，减少浪费

> 计算某个网络的IP地址数量需求：主机数量+路由器数量+2（网络地址和广播地址）

![image-20241006203837731](./images/image-20241006203837731.png)

 ![image-20241006203936256](./images/image-20241006203936256.png)



### 私有IP地址

目的地址是私有的数据报不会被路由器转发

| 类别 | 范围                        | 网段个数 |
| ---- | --------------------------- | -------- |
| A    | 10.0.0.0~10.255.255.255     | 1        |
| B    | 172.16.0.0~172.31.255.255   | 16       |
| C    | 192.168.0.0~192.168.255.255 | 256      |

> 网络地址转换NAT
>
> 安装了NAT软件的路由器叫NAT路由器

### 特殊IP地址

| 网络号 | 主机号 |                    |      |
| ------ | ------ | ------------------ | ---- |
| 0      | 0      | 本网范围内表示主机 |      |
| 全1    | 全1    | 本网广播地址       |      |
| 特定值 | 全0    | 网络的网络地址     |      |
| 特定值 | 全1    | 网络的广播地址     |      |
| 127    | any    | 环回地址           |      |



## IP数据报的发送和转发

1. 主机发送IP数据报
2. 路由器转发IP数据报

### 发送

> 判断A、B是否处于同一个网络，间接交付还是直接交付
>
> 1. 将IP和子网掩码 &得到所在网络的网络地址
> 2. 类似得到目的地址所在网络的网络地址
> 3. A != B

> 默认网关：
>
> 指定一个本网络的**路由器**帮忙转发，使主机能对外通信

1. 间接交付：先传输给默认网关，默认网关转发给目的地址
2. 直接交付：

### 路由器转发

1. 检查IP数据报首部是否出错
    1. 出错：直接丢弃，并通告数据源
2. 根据IP数据报中的目的地址在路由表中查找匹配的条目
    1. 将目的地址与路由表中的地址掩码相与， 看是否与对应的目的网络匹配
    2. 如果有多条路由条目，按照**最长网络前缀匹配**
    3. 按照匹配的路由条目的下一跳：指示了转发的接口

> 路由器抑制广播风暴
>
> 路由器是屏蔽广播域的，不会对广播IP数据报转发
>
> ![image-20241011145306904](./images/image-20241011145306904.png)

## 静态路由配置

> 静态路由配置：用户或管理员使用路由器相关命令为路由器**人工配置路由表**
>
> 特点：简单开销小，不能及时适应网络变化，在小规模网络采用
>
> 会导致路由环路的错误：配置错误、聚合不存在的网络、网络故障  

  ![image-20241015154027648](./images/image-20241015154027648.png)

###  默认路由条目

| 目的网络  | 下一跳                       | 类型 |
| --------- | ---------------------------- | ---- |
| 0.0.0.0/0 | 接口x/同一网络下的另一个地址 | 静态 |

### 特定主机路由条目

给路由器添加针对某个主机的特定路由条目

![image-20241015154827156](./images/image-20241015154827156.png)

###   静态路由配置错误导致的路由环路问题

![ ](./images/image-20241015155059402.png)

### 聚合不存在网络导致的路由环路

![image-20241015155936662](./images/image-20241015155936662.png)

### 网络故障导致的路由环路

1. 路由器检测到接口0直连的网络故障
1. 自动删除对应条目
1. 本来要走的条目被删除了，只能走默认路由，可能造成路由环路
1. 解决办法：将本来被删除的条目人工配置为一条黑洞路由
1. 路由器检测到网络恢复 → 条目恢复 → 黑洞路由条目设置为失效状态
1. 再次检测到网络故障 → 条目删除 → 黑洞路由设置为生效状态



## 网络层重要协议

1. IP
2. ICMP
3. ARP
4. RARP
5. IGMP

|      |      |      |      |
| ---- | ---- | ---- | ---- |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |

### ICMP协议

1. 差错报文
   1. 终点不可达：无法交付，向源点发送
   2. 源点抑制：拥塞丢数据，向源点发送
   3. 时间超过：TTL=0向源点发送
   4. 参数问题：首部字段有问题
   5. 改变路由，重定向
2. 询问报文
   1. ==回送请求和回答报文==：测试目的站是否可达，PING命令
   2. 时间戳请求和回答报文：用于时钟同步和测量时间


### ARP协议

完成主机/路由器IP地址到MAC地址的映射，解决下一跳走哪
ARP缓存存放IP→MAC地址的映射

1. 检查ARP告诉缓存，写入MAC帧/全1帧封装并广播ARP请求分组
2. 目的主机收到请求，向源主机单播ARP响应分组，源主机写入ARP缓存

RARP协议：完成MAC地址到IP地址的映射



### 网际组管理协议IGMP



## 路由选择协议

1. 静态路由选择
    1. 人工配置网络路由 默认路由 特定主机路由 黑洞路由
    2. 不能及时适应网络状态变化，小规模网络采用
2. 动态路由选择
    1. 通过路由选择协议自动获取路由信息
    2. 复杂开销大，可适应网络状态变化，适合大规模网络

1. 内部网关协议IGP
   1. RIP距离向量算法
   2. OSPF最短路径优先算法
2. 外部网关协议EGP
   1. BGP

因特网采用的路由选择协议特点

1. 自适应 动态路由选择 使用网络状态变化
2. 分布式 路由器之间交换路由信息
3. 分层次 划分为许多小的自治系统AS



- 域间路由选择：自治系统之间的路由选择
    - 协议类别：外部网关协议EGP(ERP)
    - 边界网关协议BGP

- 域内路由选择：内部的路由选择
    - 协议类别  ：内部网关协议IGP(IRP)
    - 路由信息协议RIP
    - 内部网关路由协议IGRP
    - 增强型EIGRP
    - 开放式最短路径优先OSPF
    - 中间系统到中间系统IS-IS

![image-20241016165749574](./images/image-20241016165749574.png)

### RIP路由信息协议 Routeing Information Protoocl

距离向量：要求每个路由器都要维护从自己到其他每一个网络的距离记录

跳数：衡量到达目的网络的距离 

1. 到直连网络的距离为：1
2. 到非直连网络的距离：经过的路由器数目+1
3. 距离为16时视为不可达，即最多15个路由器，因此，rip适用于小型互联网

RIP：

1. 好的路由就是距离短的路由，通过更少的路由器
2. 多条距离相等的路由时，进行等价负载均衡
3. 仅和相邻路由器周期性交换信息，即周期性交换路由表，通过发送RIP更新报文交换

> 相邻路由器：直连，途中没有经过其他路由器
>
> 路由信息（路由表）：
>
> | 目的网络 | 距离 | 下一跳 |
> | -------- | ---- | ------ |
> | N1       | 1    | 直连   |
> | N2       | 1    | 直连   |
> | N3       | 4    | ?      |
> |          |      |        |
>
> 

RIP工作过程：

1. 到直连网络距离1
2. 仅和相邻路由器交换更新路由信息
    1. 
3. 若干次交换更新后，每个路由器获得所有信息，收敛



### OSPF开放最短路径有限

> 开放：公开发表
>
> 最短路径优先：使用了最短路径算法
>
> 基于链路状态
>
> 链路状态：路由器和哪些路由器相邻，相应链路的代价
> 代价：例如100Mbps/链路带宽，结果小于1的值记1，大于1的舍去小数
>
> | 邻居路由器 | 代价（ |
> | ---------- | ------ |
> | R2         | 1      |
> | R4         | 10     |
> |            |        |
>
> IP数据报首部中
> 协议号：89，表明数据载荷为OSPF分组   

工作原理：

1. 相邻路由器之间通过交互问候分组，建立维护邻居关系
2. 问候分组发送周期：10s，40s未收到邻居路由器的的hello分组，认为不可达
3.  邻居表

| 邻居ID | 接口 | 死亡倒计时(为0 时判定为不可达) |
| ------ | ---- | ------------------------------ |
| R2     | 1    | 40s                            |
|        | 0    | 30s                            |
|        |      | 20s                            |



### 边界网关协议BGP





## IP数据报的首部格式

1. 20字节**固定部分** 160bit
    1. 版本字段 4bit
    2. 首部长度 4bit
        1. 首部长度= n * 4
        2. 至少为0101，即从5开始
    3. 区分服务 8bit
        1. 指示期望获得哪种类型的服务
    4. 总长度 16bit，65535 * 1 字节
        1. 即首部和数据的总长度
        2. 可以指示的理论最大值为2^16^-1字节
    5. 标识 8bit
    6. 标志 4bit
    7. 片偏移 12bit
    8. 生存时间TTL 8bit
        1. 指示IP分组的保质期，每经过一个路由器-1
    9. 协议 8bit
        1. 指示数据部分的协议，如6 → TCP  17 → UDP
    10. 首部检验和
        1. 数据报每经过一个路由器，路由器都要重新计算它 
2. 40字节**可变部分**
    1. 可选字段
        1. 支持排错、测量和安全等措施
    2. 填充字段：确保**首部长度是4的整数倍**

如果分成5行，则每行4字节=32bit

1. 版本4，首部长度4，区分服务8，总长度16
2. 标识8，标志3，片偏移13
3. 生存时间8，协议8，首部检验和
4. 源地址32
5. 目的地址32

| 首部字段       | 描述                                                         | 大小            |
| -------------- | :----------------------------------------------------------- | --------------- |
| 版本           |                                                              |                 |
| 首部长度       | 最小: 0101十进制为5，含义是首部为5*4字节<br />最大：1111=15，首部60字节<br />即**单位为4B** | 0.5字节=4bit    |
| **区分服务**   | 使用区分服务时生效，一般不使用<br />用来获得更好的服务，不同数值提供不同等级的服务质量 | **1字节=8bit**  |
| 总长度         | 首部+数据载荷的总长度<br />最大65535字节<br />**单位1B**     | 2字节=16bi      |
|                | ==分片相关字段==                                             |                 |
| 标识           | 同一个数据报的**各分片**数据报的标识相同<br />每产生一个IP数据报，计数器+1并赋值给标识 | 2字节=16bit     |
| 标志           | MF位：1后面有分片，0后面无分片<br />DF位：1不允许再分片，0允许分片<br />保留位：0 | 0.375字节=3bit  |
| 片偏移         | 分片数据报的数据载荷部分**相对最原始**数据报数据载荷部分的偏移，<br />**单位8B** | 1.625字节=13bit |
|                | **第三行**                                                   |                 |
| 生存时间TTL    | 路由器转发-1，为0时丢弃IP数据报<br />防止IP数据报永久兜圈    | 1字节=8bit      |
| 协议           |                                                              |                 |
| ==首部检验和== | 检验首部                                                     |                 |
| 源地址         | IP地址                                                       | 32bit           |
| 目的地址       | IP地址                                                       | 32bit           |
| 可选字段+填充  | 排错、测量、安全等措施，也会增加处理开销，很少使用<br />全0填充确保首部长度为4的整数倍 | 1~40字节        |

> 数据载荷长度=总长度-首部长度=总长度字段值-首部长度字段值*4
>
> 

## IP数据报分片

> [!note]
>
> 最大传输单元MTU：IP数据报在数据链路层封装成帧，数据链路层协议规定帧的数据载荷的最大长度，即对应IP数据报有最大长度限制
> 以太网MTU：1500字节
>
> IP数据报总长度 > MTU时，将IP数据报分片为更小的IP数据报，再将分片封装成帧
> **一般会将IP数据报分片=MTU**

1. 标识16：同一数据报的所有分片使用相同的标识
2. 标志3：
   1.  中间位DF：1禁止分片0允许分片
   2. 最低位MF(more?)：1还有分片0没有分片
3. 片偏移13：分片相对原分组的位置，单位8B

> [!ques]
>
> 首部20B+数据部分3800B，需要分片为长度不超过1420B的数据报
>
>  [!ans]
>
> 20B+1400B + 20B + 1400B + 20B + 1000B
>
> | 数据报 | 总长度 | 标识   | MF   | DF   | 片偏移 |
> | ------ | ------ | ------ | ---- | ---- | ------ |
> | 原始   | 3820   | 12345  | 0    | 0    | 0      |
> | 1      | 1420   | 12345  | 1    | 0    | 0      |
> | 2      | 1420   | 12345  | 1    | 0    | 1400/8 |
> | 3      | 1020   | 123450 | 0    | 0    | 2800/8 |
>
> 
