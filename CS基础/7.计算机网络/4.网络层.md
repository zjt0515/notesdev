# 网络层

- [ 小林coding](https://xiaolincoding.com/network/4_ip/ip_base.html)

> [!important]
>
> 1. 分析IP地址的类型
> 2. 根据MAC帧/IP数据报，分析首部关键字段
> 3. IP数据报分片原因和计算
> 4. ARP协议的作用和工作原理
> 5. 因特网控制报文协议ICMP和PING应用
> 6. 子网划分和地址分配
>    1. 计算子网掩码
>    2. 计算子网地址
>    3. 计算子网容纳的主机数
>    4. 计算子网的最小IP地址、最大的IP地址和广播地址
> 7. 直接交付/间接交付
> 8. 无分类编制，路由聚合，无分类编址下路由选择的最长前缀匹配原则
> 9. 

## 路由算法

路由表/转发表

| 目的网络IP地址 | 子网掩码 | 下一跳IP地址 | 接口 |
| -------------- | -------- | ------------ | ---- |
|                |          |              |      |
|                |          |              |      |
|                |          |              |      |

最佳路由：链路

## 网络层服务

1. 面向连接的虚电路服务
    1. 可靠通信由网络来保证
    2. 必须建立网络层连接——虚电路VC
    3. 沿着虚电路发送分组
    4. 连接建立阶段使用目的主机地址，之后的分组首部只需携带一条虚电路编号
    5. 通信结束，虚电路释放
    6. 配合可靠传输的网络协议，可使分组正确到达，很多广域分组交换网使用
2. 无连接的数据报服务
    1. 可靠通信由用户主机来保证
    2. 不需要建立网络层连接
    3. 每个分组可走不同的路径
    4. 每个分组首部必须携带完整主机地址
    5. 分组可能误码、丢失、重复、失序
    6. 网络本身不提供端到端的可靠传输服务，路由器可以简化、价格低
    7. 因特网采用这种设计：将复杂的网络处理功能置于因特网边缘

##  ==IPV4地址分类==

主机或路由器的每一个接口服呢配一个唯一的32比特标识符

编制方法的三个历史阶段：

1. 分类编制
2. 划分子网
3. 无分类编址

> [!note]
>
> ip地址表示方法：
>
> 1. 32比特: 00000000 00000000 00000000 00000000
> 2. 点分十进制：0.0.0.0(每8个比特分为一组，转化为十进制，用.分隔)

### 分类编址的IPV4

| 网络      | 网络号                                                       | 主机号(全0网络全1广播) | 默认子网掩码  |
| --------- | ------------------------------------------------------------ | ---------------------- | ------------- |
| A         | 0xxxxxxx<br />0~127<br />网络数量126                         |                        | 255.0.0.0     |
| B         | 10xxxxxx xxxxxxxx<br />128.0~191.255<br />网络数量           |                        | 255.255.0.0   |
| C         | 110xxxxx xxxxxxxx xxxxxxxx<br />192.0.0~223.255.255<br />网络数量 |                        | 255.255.255.0 |
| D         | 224~239                                                      |                        |               |
| E保留地址 | 240~255                                                      |                        |               |

1. A类： 8/24
    1. 网络号0开头
    2. 可指派的网络号（网络数量）：1~126，共126个
    3. 每个网络中可分配的的IP地址： 2^24^-2
    4. 本地环回测试地址：127.0.0.1~127.255.255.254

2. B类：16/16
    1. 网络号10开头
    2. 可指派的网络号：128.0~191.255，共2^(16-2)^个
    3. 每个网络可分配的IP地址：2^16^-2（65536-2

3. C类： 24/8
    1. 网络号110开头
    2. 可指派的网络号：192.0.0~223.255.255，共2^24-3^
    3. 每个网络可分配的IP地址：2^8^-2

4. D类：多播地址，1110
5. E类：保留地址，1111

> [!tip]
>
> 某类网络可指派的网络号由其可变的网络号比特位决定：$2^$
>
> 网络中可分配的ip地址由主机号的比特位数量决定：2^n^-2

> [!warning]
>
> 只有ABC类地址可分配给网络主机或路由器的结果口

> [!note]
>
> 网路号和主机号
>
> - 网络号：
>
>   - 全0：保留不指派(只有A类可能有)
>
>   - 全1：最大网络号
>
> - 主机号，全0或全1不能分配
>
>   - 全0：对应网络的网络地址
>
>   - 全1：对应网络的广播地址





> [!note]
>
> 特殊IPV4地址
>
> `0.0.0.0`：只能作为源地址，表示本网络上的本主机，封装有DHCP发现报文的IP分组的源地址使用
>
> `127.0.0.1~127.255.255.254`：本地软件环回测试，既可以作为源地址使用，也可以作为目的地址使用
>
> `255.255.255.255`，即全1地址，只能作为目的地址，表示只在本网络上进行广播
>
> `0.x.x.x`：只能作为源地址，表示本网络中的某台主机

IPV4地址与指派性练习

![image-20240929154315639](./images/image-20240929154315639.png)

IPV4地址分配练习

![image-20240929160026531](./images/image-20240929160026531.png)

### 划分子网的IPV4地址

申请新网络地址，等待时间和花费费用，浪费原有网络中的的IP地址，增加其他路由器中路由表记录的数量

划分子网的IPV4地址：子网掩码

1. 借用主机号的部分比特位来作为子网号，借用n个比特位，可划分出2^n^个子网
2. 每个子网可分配的ip地址数量为：2^k-n^-2
3. 子网掩码：网络号和子网号全1，主机号全0

使用子网掩码得到IP的网络号+子网号

网络号.子网号.主机号

 ![image-20240929170023808](./images/image-20240929170023808.png)



![image-20240929170121794](./images/image-20240929170121794.png)

![image-20240929171406186](./images/image-20240929171406186.png)

默认的子网掩码：未划分子网的情况下使用的子网掩码

![image-20240929171600886](./images/image-20240929171600886.png)

### 无分类编址的IP地址

无分类域间路由选择CIDR：消除传统ABC类地址和划分子网概念，更加有效地分配IPV4地址空间

 CIDR使用斜线记法：ipv4 / [网路前缀所占的比特数量]

将网络前缀相同的连续IP地址组成一个CIDR地址快

只要知道CIDR地址块中的一个地址，就能知道该地址块的全部细节

![image-20240929201446161](./images/image-20240929201446161.png)

路由聚合（构造超网）

1. 找出共同前缀吗
2. 将其余位数全部取0，作为/的前面部分
3. 将**共同前缀的位数**放到/后面部分
4. 获得聚合后的地址块

> 网络前缀越长，地址块越小，路由越具体
>
> 最长前缀匹配：路由器查表转发分组时发现多条路由，选择网络前缀更长的那条

###  IPV4地址的应用规划

1. 采用定长子网掩码
    1. 子网的IP地址数量相同，地址浪费
    2. 子网数量决定了需要借用最少的比特位，也决定了每个子网的IP数量
2. 采用变长子网掩码
    1. 子网的IP地址数量可以不同，减少浪费

> 计算某个网络的IP地址数量需求：主机数量+路由器数量+2（网络地址和广播地址）

![image-20241006203837731](./images/image-20241006203837731.png)

 ![image-20241006203936256](./images/image-20241006203936256.png)





## IP数据报的发送和转发

1. 主机发送IP数据报
2. 路由器转发IP数据报

### 发送

> 判断A、B是否处于同一个网络，间接交付还是直接交付
>
> 1. 将IP和子网掩码 &得到所在网络的网络地址
> 2. 类似得到目的地址所在网络的网络地址
> 3. A != B

> 默认网关：
>
> 指定一个本网络的**路由器**帮忙转发，使主机能对外通信

1. 间接交付：先传输给默认网关，默认网关转发给目的地址
2. 直接交付：

### 路由器转发

1. 检查IP数据报首部是否出错
    1. 出错：直接丢弃，并通告数据源
2. 根据IP数据报中的目的地址在路由表中查找匹配的条目
    1. 将目的地址与路由表中的地址掩码相与， 看是否与对应的目的网络匹配
    2. 如果有多条路由条目，按照**最长网络前缀匹配**
    3. 按照匹配的路由条目的下一跳：指示了转发的接口

> 路由器抑制广播风暴
>
> 路由器是屏蔽广播域的，不会对广播IP数据报转发
>
> ![image-20241011145306904](./images/image-20241011145306904.png)

## 静态路由配置

> 静态路由配置：用户或管理员使用路由器相关命令为路由器**人工配置路由表**
>
> 特点：简单开销小，不能及时适应网络变化，在小规模网络采用
>
> 会导致路由环路的错误：配置错误、聚合不存在的网络、网络故障  

  ![image-20241015154027648](./images/image-20241015154027648.png)

###  默认路由条目

| 目的网络  | 下一跳                       | 类型 |
| --------- | ---------------------------- | ---- |
| 0.0.0.0/0 | 接口x/同一网络下的另一个地址 | 静态 |

### 特定主机路由条目

给路由器添加针对某个主机的特定路由条目

![image-20241015154827156](./images/image-20241015154827156.png)

###   静态路由配置错误导致的路由环路问题

![ ](./images/image-20241015155059402.png)

### 聚合不存在网络导致的路由环路

![image-20241015155936662](./images/image-20241015155936662.png)

### 网络故障导致的路由环路

1. 路由器检测到接口0直连的网络故障
1. 自动删除对应条目
1. 本来要走的条目被删除了，只能走默认路由，可能造成路由环路
1. 解决办法：将本来被删除的条目人工配置为一条黑洞路由
1. 路由器检测到网络恢复 → 条目恢复 → 黑洞路由条目设置为失效状态
1. 再次检测到网络故障 → 条目删除 → 黑洞路由设置为生效状态



## 路由选择协议

1. 静态路由选择
    1. 人工配置网络路由 默认路由 特定主机路由 黑洞路由
    2. 不能及时适应网络状态变化，小规模网络采用
2. 动态路由选择
    1. 通过路由选择协议自动获取路由信息
    2. 复杂开销大，可适应网络状态变化，适合大规模网络



因特网采用的路由选择协议特点

1. 自适应 动态路由选择 使用网络状态变化
2. 分布式 路由器之间交换路由信息
3. 分层次 划分为许多小的自治系统AS



- 域间路由选择：自治系统之间的路由选择
    - 协议类别：外部网关协议EGP(ERP)
    - 边界网关协议BGP

- 域内路由选择：内部的路由选择
    - 协议类别  ：内部网关协议IGP(IRP)
    - 路由信息协议RIP
    - 内部网关路由协议IGRP
    - 增强型EIGRP
    - 开放式最短路径优先OSPF
    - 中间系统到中间系统IS-IS

![image-20241016165749574](./images/image-20241016165749574.png)

### 路由信息协议RIP Routeing Information Protoocl

距离向量：要求每个路由器都要维护从自己到其他每一个网络的距离记录

跳数：衡量到达目的网络的距离 

1. 到直连网络的距离为：1
2. 到非直连网络的距离：经过的路由器数目+1
3. 距离为16时视为不可达，即最多15个路由器，因此，rip适用于小型互联网

RIP：

1. 好的路由就是距离短的路由，通过更少的路由器
2. 多条距离相等的路由时，进行等价负载均衡
3. 仅和相邻路由器周期性交换信息，即周期性交换路由表，通过发送RIP更新报文交换

> 相邻路由器：直连，途中没有经过其他路由器
>
> 路由信息（路由表）：
>
> | 目的网络 | 距离 | 下一跳 |
> | -------- | ---- | ------ |
> | N1       | 1    | 直连   |
> | N2       | 1    | 直连   |
> | N3       | 4    | ?      |
> |          |      |        |
>
> 

RIP工作过程：

1. 到直连网络距离1
2. 仅和相邻路由器交换更新路由信息
    1. 
3. 若干次交换更新后，每个路由器获得所有信息，收敛



### 开放最短路径有限OSPF

> 开放：公开发表
>
> 最短路径优先：使用了最短路径算法
>
> 基于链路状态
>
> 链路状态：路由器和哪些路由器相邻，相应链路的代价
> 代价：例如100Mbps/链路带宽，结果小于1的值记1，大于1的舍去小数
>
> | 邻居路由器 | 代价（ |
> | ---------- | ------ |
> | R2         | 1      |
> | R4         | 10     |
> |            |        |
>
> IP数据报首部中
> 协议号：89，表明数据载荷为OSPF分组   

工作原理：

1. 相邻路由器之间通过交互问候分组，建立维护邻居关系
2. 问候分组发送周期：10s，40s未收到邻居路由器的的hello分组，认为不可达
3.  邻居表

| 邻居ID | 接口 | 死亡倒计时(为0 时判定为不可达) |
| ------ | ---- | ------------------------------ |
| R2     | 1    | 40s                            |
|        | 0    | 30s                            |
|        |      | 20s                            |



### 边界网关协议BGP



## 网际协议

### IP数据报格式

 

### IP数据报分片

## IP数据报的首部格式

1. 20字节**固定部分** 160bit
    1. 版本字段 4bit
    2. 首部长度 4bit
        1. 首部长度= n * 4
        2. 至少为0101，即从5开始
    3. 区分服务 8bit
        1. 指示期望获得哪种类型的服务
    4. 总长度 16bit，65535 * 1 字节
        1. 即首部和数据的总长度
        2. 可以指示的理论最大值为2^16^-1字节
    5. 标识 8bit
    6. 标志 4bit
    7. 片偏移 12bit
    8. 生存时间TTL 8bit
        1. 指示IP分组的保质期，每经过一个路由器-1
    9. 协议 8bit
        1. 指示数据部分的协议，如6 → TCP  17 → UDP
    10. 首部检验和
        1. 数据报每经过一个路由器，路由器都要重新计算它 
2. 40字节**可变部分**
    1. 可选字段
        1. 支持排错、测量和安全等措施
    2. 填充字段：确保**首部长度是4的整数倍**

