## 单片机中断系统

> 中断：终止原程序，转而执行相应的处理程序
> 所谓中断是指在计算机正常工作的过程中，由于系统内、外发生的随机事件，使计算机必须暂停现行程序的执行，而转去执行处理该事件的程序。待该处理程序执行完毕，计算机再返回到原来被中断的程序继续执行的过程；
> 为实现中断功能而设定的各种硬件和软件统称为中断系统。
>
> 中断实现过程
>
> 1. 请求
> 2. 响应
> 3. 服务
> 4. 返回

![image-20250104124353283](./images/image-20250104124353283.png)

### 中断源

EA为总中断允许，EA=1时各中断源的中断申请方能送达CPU的中断系统。

中断源: 中断源是向CPU申请中断的外部事件的来源
每一个中断源都对应一个中断请求标志位，它们设置在特殊功能寄存器TCON、T2CON和SCON中。当某中断源请求中断时，分别由相应的SFR中的对应位来锁存；

| 中断源      | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| INT0'       | 外部中断请求0，低电平或下降沿有效，由P3.2引脚输入；          |
| 定时器0     | 定时器/计数器0溢出中断请求，计数来源为机器周期（T0<br/>作为定时器使用）或由P3.4输入的负脉冲（T0作为计数器使<br/>用）； |
| INT1'       | 外部中断请求1，低电平或下降沿有效，由P3.3引脚输入；          |
| 定时器1     | 定时器/计数器1溢出中断请求，计数来源为机器周期（T1<br/>作为定时器使用）或由P3.5输入的负脉冲（T1作为计数器使<br/>用）； |
| 串行口Tx/Rx | 串行通信中断请求。当串行口完成一帧数据的发送或接<br/>收时，请求中断； |

### 中断优先级

> 当两个或两个以上的中断源同时申请中断时，CPU确定响应这些中断的顺序，称为中断优先级；
>
> MCS-51的5个中断源分为高和低两个中断优先级；
>
> 各中断源在SFR中都有可编程位来控制允许/禁止中断；
>
> 当设置EA=0或系统复位后，系统将屏蔽所有的中断请求，只有设置EA=1才能接受中断请求；
>
> 各中断源在SFR中还有相应的可编程位来选择该中断源的优先级为高或低；
>
> 两级中断可嵌套，即一个正在执行的低优先级中断服务程序能（且仅能）被高优先级中断请求所中断；
>
> 中断处理结束返回主程序后，CPU至少要再执行一条指令，才能响应新的中断请求。

### 中断请求标志寄存器

1. TCON: 定时器/计数器控制寄存器；
    1. TF1: 溢出中断请求标志位，T1计数产生溢出，TF1置1，响应中断后清零
    2. TF0：溢出中断请求
    3. IE1：外部中断请求1
    4. IE0：外部中断请求0
    5. IT1：选择外部中断请求1为跳沿还是电平触发
    6. IT0: 选择外部中断请求0
2. SCON：串行口控制寄存器；
    1. TI：串行口发送中断请求标志位
    2. RI：接受中断请求比奥职位
3. 中断允许寄存器IE：为1允许中断请求，为0禁止中断请求
4. 中断优先级寄存器IP：中断请求源有2个中断优先级，1高0低
    1. PT2：定时器T2中断优先级控制位
    2. PS：串行口中断优先级控制位
    3. PT1：定时器T1
    4. PX1：外部中断1
    5. PT0：定时器T0
    6. PX0：外部中断0
    7. 同级内优先级：外部中断0 > 定时器0 > 外部中断1 > 定时器1 > 串行口 > 定时器2

#### TCON

| 地址   |        | TCON位     |        |
| ------ | ------ | ---------- | ------ |
| 8FH    | D7 | TF1        | 定时器/计数器1（T1）的溢出标志。当T1的内部计数器<br/>计数溢出时，由硬件将TF1置1。TF1同时是T1的中断请求标志，<br/>也可供程序查询。当系统设置允许该中断时，CPU响应该中断进<br/>入中断服务程序后，由硬件将TF1自动清0，不需要软件清0。 |
| 8EH    | D6 | TR1        |        |
| 8DH    |        | TF0        | 定时器/计数器0（T0）的溢出标志，功能和操作同TF1。 |
| 8CH    |        | TR0        |        |
| 8BH    |        | IE1        | 外部中断1（INT1）的中断请求标志。当检测到外部中断1<br/>引脚（P3.3）上存在有效的中断请求信号时，由硬件使IE1置1，<br/>当CPU响应该中断请求时，同样由硬件使IE1清0。 |
| 8AH    |        | IT1        | 外部中断1的中断触发方式控制位。<br />IT1=0时，INT1为电平触发方式，CPU在每个机器周期S5P2采样INT1引脚上的输入电平，若INT1为低电平，则置IE1=1，向CPU申请中断；若INT1为高电平，则置IE1=0。<br />IT1=1时，INT1为边沿触发方式。CPU在每个机器周期S5P2采样INT1引脚上的输入电平。如果在连续两个机器周期的采样过程中，第一个机器周期采样到的INT1引脚为高电平，第二个机器周期采样到该引脚为低电平（即采样到一个下降沿），则使IE1置1，向CPU申请中断；即使这个下降沿已经结束，IE1也一直保持为1，直到CPU响应该中断时，才由硬件控制将IE1清<0。因此，下降沿方式的中断出发请求可以保持。 |
| 89H    |        | IE0        | 外部中断0（INT0）的中断请求标志。其含义与IE1类同。 |
| 88H    | D0 | IT0        | 部中断0的中断触发方式控制位。其含义与IT1类同。 |

#### SCON



#### IE

各中断允许位为0，禁止CPU响应对应的中断；为1，允许CPU响应对应的中断。

| 地址 |      | IE位 |                                                              |
| ---- | ---- | ---- | ------------------------------------------------------------ |
| 0AFH | D7   | EA   | 中断允许总控制位；<br/>Ø EA=0，屏蔽所有中断请求；<br/>Ø EA=1，CPU开放中断，但是否响应各中断源的中断请求，还要<br/>取决于各中断源的中断允许控制位的状态。 |
| 0AEH | D6   | x    |                                                              |
| 0ADH |      | x    |                                                              |
| 0ACH |      | ES   | 串行口中断允许位；                                           |
| 0ABH |      | ET1  | T1的中断允许位；                                             |
| 0AAH |      | EX1  | INT1的中断允许位；                                           |
| 0A9H |      | ET0  | T0的中断允许位；                                             |
| 0A8H | D0   | EX0  | INT0中断允许位；                                             |


> 其中TCON和SCON只有一部分控制位用于中断控制。通过对以上各特殊功能寄存器和中断系统中有关的控制位进行置位或复位操作，可实现各种中断控制功能。

#### IP

 中断优先级控制寄存器IP: MCS-51/52有两个中断优先级。只要通过程序设置中断优先级寄存器IP中的对应位，每一个中断源都可被编程为高优先级中断或低优先级中断

若某一控制位为1，则相应的中断源就规定为高优先级中断；
若某一控制位为0，则相应的中断源就规定为低优先级中断。

> 当同时收到几个同一优先级的中断请求时，响应哪一个中断源则取决于内部硬件查询顺序，用户无法自行更改。其优先处理顺序排列如下：
>
> ![image-20250104125919913](./images/image-20250104125919913.png)

| 地址 |      | IP位 |                                    |
| ---- | ---- | ---- | ---------------------------------- |
|      |      | x    |                                    |
|      |      | x    |                                    |
|      |      | x    |                                    |
|      |      | PS   | 串行口中断优先级控制位；           |
|      |      | PT1  | 定时器/计数器1的中断优先级控制位； |
|      |      | PX1  | 外部中断1的中断优先级控制位；      |
|      |      | PT0  | 定时器/计数器0的中断优先级控制位； |
|      |      | PX0  | 外部中断0的中断优先级控制位；      |



1. 响应低级中断请求
2. 响应高级中断请求
3. 执行高级中断子程序
4. 执行低级中断子程序

> [!tip]
>
> 单片机复位后，TCON清零，所有中断源的中断请求标志位为0

```c
// 允许T1T0中断，禁止其他中断请求，写出设置IE的相应代码
ES=0; // 禁止串行口中断
EX0=0; // 禁止外部中断0中断
EX1=0;  // 静止外部中断1中断
ET2=0; // 禁止T2中断
ET0=1; // 允许T0 中断
ET1=1; // 允许T1中断
EA=1; // 总中断开放
```

### 中断响应

在开中断的情况下，CPU在每一个机器周期的S5P2状态对中断
标志采样，而在下一个机器周期对采样到的中断请求按优先级
或优先处理顺序进行查询；
l下列条件中的任何一个都能封锁CPU对中断的响应：

1. 一个同级或高一级的中断正在处理中；
2. 现行的机器周期不是当前所执行指令的最后一个机器周期；
3. 当前正在执行的指令是中断返回（RETI）指令或对IE或IP寄存器进行读写的指令。

中断响应的条件

1. 如果满足中断条件，CPU内部硬件将在响应中断时自动生成一条长调用（LCALL）指令，转到相应的中断服务程序执行中断处理；
2. 如不满足中断条件，则丢弃此次中断扫描结果，但只要被挂起的中断源的申请未撤销，一旦条件满足，CPU仍将响应该中断。

中断响应的过程

1. CPU响应中断时，先封锁同级和低级的中断；
2. 对于T0、T1和INT0、INT1，其中断申请标志在CPU响应中断时由硬件自动清除；
3. 对于串行口中断的中断申请标志，因其是由2个中断源共用的，其标志必须提供给用户程序查询以确定具体的中断源，因此必须由用户软件清除；
4. 此后在硬件的控制下，程序转向相应中断向量指向的入口地址，执行中断服务程序。
5. 硬件调用中断服务程序时，为保证执行完中断服务程序后能返回被中断处继续执行，CPU会自动将当前的PC值压入堆栈，这个过程称为保护现场；
6. 在保护现场的同时，把被响应的中断服务程序的入口地址装入PC，控制程序转向中断服务程序执行。
7. 中断服务程序的入口地址又称为中断向量地址，在MCS-51单片机中，中断向量地址指向程序存储器，且有各自固定的值：

> 各中断向量的入口地址![image-20250104130157297](./images/image-20250104130157297.png)

中断响应的时间：单片机在开中断时，从中断源发出中断请求到CPU响应中断并根据中断向量转移到中断服务程序中执行是需要一定时间的。在这个过程中，可能会有如下四种不同的情况：

1. 经中断优先级查询，如果中断请求有效且满足中断响应的三个条件，则主机立即响应中断请求，由内部硬件自动生成并执行长调用（LCALL）指令，程序转向以对应中断向量地址为入口的中断服务程序处开始执行；长调用（LCALL）指令是一条双周期指令，因此主机从中断采样，经中断优先级查询，生成和执行LCALL指令，共需3个机器周期，才能执行中断服务程序。这时主机响应中断速度最快，中断响应时间为3个机器周期。 
2. 在中断优先级查询过程中，如果当前正在执行的指令尚未执行完成（例如对于多周期指令，当前指令周期不是该指令的最后一个机器周期），由于中断响应必须等到当前指令结束，而指令的执行时间分为单周期、双周期或4个机器周期，所以在这种情况下，中断响应时间需4～7个机器周期。
3. 在中断优先级查询过程中，如当前正在执行的是RET、RETI或访问IE、IP等和中断系统的设置及控制相关的指令，即使其他条件都满足，CPU也需等当前指令及下一条指令执行完成后才能响应中断。在这种情况下，中断响应时间需5～8个机器周期；
4. 如果当前正在执行的是同级或高优先级中断服务程序，则该中断请求将被挂起，只有等目前的中断服务程序执行完成后CPU才能响应该中断请求。在这种情况下，中断响应时间无法估算。

根据上述分析可见，对于MCS-51单片机系统，从中断申请出现到CPU响应之间的时间无法准确计算，一般中断响应时间总是在3～8个机器周期之间变化。对于实时性要求较高的应用场合，响应时间的不确定性所造成的随机延时可能无法接受，在系统设计时应加以注意。

### 中断请求撤销

1. T0和T1中断请求的撤销
l当CPU响应T0或T1的中断转向执行中断服务程序的同时，内部硬件自动复位中断请求标志位，即自动撤除了中断请求；
l只有当递增计数器再次计数溢出回0时，才会再次置位中断请求标志位，向CPU提出新的中断请求；
l因此，在设计定时器/计数器的中断服务程序时，要注意中断服务程序的执行时间一定要小于两次计数器溢出事件之间的时间间隔，否则将可能丢失后续的中断请求。

2. INT0和INT1中断请求的撤销
l当INT0或INT1被设置为电平有效中断时：
Ø 当CPU响应中断请求并转向执行中断服务程序时，中断请求标志位IE0或IE1将由中断系统的内部硬件自动清0；
Ø 如果此时中断申请信号仍保持有效，则CPU从中断服务程序返回后只要再执行一条指令，中断请求标志位（IE0或IE1）就会再次置位，造成同一中断申请多次被响应的情况；
Ø 因此对于低电平有效的外部中断请求信号，应该在中断服务程序中将中断申请信号撤除。
3. 串行通信中断请求的撤销
    l当串行通信接口接收或发送完一帧数据后，将自动置位中断申请标志位RI（接收）或TI（发送），向CPU申请中断；
    l这两个中断源合用同一个中断向量地址（0023H）、同一个中断允许/禁止位ES以及同一个中断优先级选择位PS；
    l由于RI和TI都会引起串行通信中断请求，所以串行通信中断服务程序必须通过软件查询RI和TI才能确定引起本次中断的中断源，并转向对应的中断服务程序去执行，因此，串行通信中断申请就不能由中断系统内部硬件自动清0，而是在中断服务程序中判断出中断源后，由软件编程清0中断请求标志位RI或TI，完成中断请求的撤除。

### 中断应用

设计中断服务子程序流程

1. 设置IE，允许相应的中断请求源中断
2. 设置IP，确定使用的中断源优先级
3. 若是外部中断源，设置中断请求的触发方式
4. 编写中断服务子程序



```c
// 定时器中断函数
void Timer0_Routine()interrupt 1
{
  static unsigned  int T0Count;
  TL0 = 0x18;
  TH0 = 0xFC;
  T0Count++;
  if(T0Count >= 1000)
  {
    T0COunt = 0;
  }
}
```

## 外部总线拓展

> 单片机的内部集成了组成计算机的基本功能部件，一块单片机就相当于一个基本的计算机系统；
> l 对于智能仪器、仪表、小型测控等简单应用系统，可直接使用单片机而不必扩展外围芯片，极为方便高效；
> l 对于一些功能复杂的应用，单片机内部的资源往往就显得不足，需要在其外围扩展一些器件，以适应系统的需要；
> l 单片机系统中扩展的器件必须从属于单片机，受单片机的支配和指挥，扩展器件和单片机之间必须互相连接，以便交换必要的信息；
> l 用于连接CPU和扩展器件的公用信息通路称为总线。
>
> 单片机的总线分为地址总线、数据总线和控制总线；
> l 系统总线扩展时，单片机的P0端口分时作为地址总线低8位和数据总线；P2端口作为地址总线的高8位；
> l 单片机的控制总线包括WR、RD和PSEN；
> l WR为数据总线写选通信号；
> l RD为数据总线读选通信号；
> l PSEN为程序存储器读选通信号。
> l 单片机通过ALE引脚控制地址锁存器（74LS373或74LS573等8D锁存器）实现单片机P0端口的地址总线/数据总线的时分复用。

### 地址空间分配和译码

地址空间的分配，是在16位地址线所决定的64KB可寻址范围内，给外部扩展的器件划分有效地址空间范围的过程；
l 在扩展了多个外围器件的单片机系统中，单片机是通过地址总线和控制总线来选择和确定具体的被寻址器件或存储单元的。要完成这一操作功能需进行两方面的寻址：
Ø片选：选择并确定被寻址的器件（芯片）；
Ø字选：在片选信号有效的情况下，寻址该器件（芯片）内部的某个存储单元或功能寄存器。 
地址空间的分配有两种方法：
Ø线选法；
Ø地址译码法。

1. 线选法
l 线选法的原理：Ø将多余的地址线(即除去系统正常功能所需占用的地址线外)作为片选信号线的地址分配方法，某根地址线有效，则对应的某个器件（芯片）被选中并激活，处于工作状态。
l 优点：Ø硬件实现简单，不需附加其他器件（例如译码器之类），可减少硬件的成本；
l 缺点：Ø每根地址线只能用于选通一个设备，占用地址范围大，可扩展器件数量少。
1. 地址译码法
l 地址译码法的原理：Ø根据应用系统扩展资源的配置情况，有选择地占用一定量的地址线，经译码逻辑生成片选信号线；
l 优点：Ø地址空间安排灵活，可减少每个扩展器件占用的地址空间范围，增加扩展器件的数量；
l 缺点：Ø电路较线选法复杂，成本高。

![image-20250104163828675](./images/image-20250104163828675.png)

![image-20250104163835574](./images/image-20250104163835574.png)

## 定时器/计数器

> 51单片机有两个16位定时器/计数器，分别为T0和T1。T0和T1 又分别可分为两个8位定时器/计数器，名为TH0/TL0和TH1/TL1；
> l 定时器/计数器的本质是计数器：
> Ø当选择单片机的机器周期作为计数对象时，由于机器周期出现的频率和晶振频率之间的关系是固定的，对固定频率的信号进行计数实际上就是定时器；
> Ø当对通过T0引脚（P3.4）或T1引脚（P3.5）引入的外部脉冲作为计数对象时，它们是计数器。 
> l 定时器/计数器的工作方式由单片机内部的特殊功能寄存器TMOD指定；定时/计数的开始/停止以及状态变化监控则由特殊功能寄存器TCON来指定/保存；
>
> 当T0或T1用做定时器时，其计数脉冲来源于晶振时钟输出信号的12分频，即每个机器周期使计数器加1；
> l 因此只要单片机的晶振频率选定，机器周期也就随之确定，从而使对机器周期的计数转换为对确定时间的计数；
> l 例如，当单片机晶振频率为12MHz时，一个机器周期就是1μs，即计数器对机器周期每计数一次，就是1μs。
> l 当T0或T1用做计数器时，只要T0或T1引脚上有一个从1到0的负跳变，相应的计数器就加1；
> l 由于单片机只在每个机器周期的S5P2状态对T0及T1引脚上的电平进行一次采样，同时单片机需要用两个机器周期来识别一次负跳变，所以单片机计数器的最高计数频率为晶振频率的1/24。
>
>  不管是作为定时器还是计数器，T0和T1都只能递增计数；
> l 当16位计数器的计数值增加到0FFFFH时，下一次计数脉冲的到达将会使计数器的值回到0000H，计数器产生溢出信号，置位相应的标志位，并向主机申请中断；
> l 由于递增计数的特性，当设定计数次数时，必须以计数器的计数量程减去要设置的计数次数作为初值赋给计数器，才能在设定的计数次数后置位标志位，向CPU申请中断。 
> l T0和T1分别由两个8位SFR：THx和TLx（x=0/1）组成，它们可被软件编程设置为不同的组合状态（13位、16位或两个独立的8位计数器），从而形成定时器/计数器的4种工作方式，工作方式的选择及控制由两个SFR：TMOD、TCON的内容决定。

### 工作方式控制寄存器TMOD

定时器模式：内部脉冲
计数器模式：外部脉冲，需要2个及以上机器周期

![image-20250104163039193](./images/image-20250104163039193.png)

1. 工作方式控制寄存器TMOD，高4位控制T1，低4位控制T0
    1. GATE门控位：
        1. 当GATE=0时，TCON寄存器中的TR0或TR1（定时器/计数器运行控制位）为1则可立即启动定时器/计数器0或1进行计数；
        2. 当GATE=1时，不但要求TR0或TR1为1，而且要求单片机的INT0或INT1引脚的输入也为高电平时，才能启动定时器/计数器0或1进行计数。
    2. M1M0工作方式选择位
        ![image-20250104163115104](./images/image-20250104163115104.png)
    3. C/T'计数器模式和定时器模式选择位：0定时器1计数器
        当该位为0时为选择定时（Timer）功能，即定时器/计数器的内部计数器对单片机的机器周期进行计数，从而实现定时功能；
        当该位为1时为选择计数（Counter）功能，即定时器/计数器的内部计数器对单片机的T0或T1引脚引入的外部脉冲进行计数。

### 定时器/计数器控制寄存器TCON

![image-20250104163224797](./images/image-20250104163224797.png)

1. TF1、TF0计数溢出标志位，1溢出0清零
2. TR1、TR0计数运行控制位，由软件控制，1启动0停止

TF1：定时器/计数器1的溢出标志。当T1计数溢出时，由硬件将此位置1。TF1可供程序查询，同时也是定时器/计数器1的中断请求标志。如果中断系统被设置允许该中断，则当CPU响应中断，进入中断服务程序后，由硬件将TF1自动清0，不需要软件处理；
l TF0：定时器/计数器0的溢出标志。其功能和操作方式同TF1。
l TR1：定时器/计数器1的运行控制位。通过软件置1或清0来启
动或停止T1内部计数器的计数;
l TR0：定时器/计数器0的运行控制位。其功能和操作方式同TR0； 
l 单片机复位后，TCON寄存器的所有位均为0。

### 工作方式

![image-20250104163314818](./images/image-20250104163314818.png)

![image-20250104163331956](./images/image-20250104163331956.png)



![image-20250104163339899](./images/image-20250104163339899.png)

![image-20250104163347155](./images/image-20250104163347155.png)



> 1. 机器周期=6us*12=2us 
> 2. (最大延时时间达不到1s)每隔1ms产生一次中断 

```c
// 时钟频率6MHz，通过定时器0中断控制P2口的8个LED间隔1s闪烁
// 1.计算计数器初值X
#incldue <reg51.h>
// 统计中断次数
chat i = 100;
void main(){
  TMOD = 0x01;
  // 根据定时时间计算初值
  TH0 = 0xee;
  TL0 = 0x00;
  P1 =  0x00;
  
  EA = 1; // 打开总中断
  ET0 = 1; // T0定时器中断打开
  TR0 = 1; // 启动 定时器
  while(1)
  {
    ;
  }
}
// T0 中断程序
void timer0() interrupt 1
{
  TH0 = 0xee;
  TL0 = 0x00;
  i--;
  if(i <= 0){
    P1 = ~P!;
    i = 100;
  }
}
```



> [!tip]
>
> 确定TMOD寄存器初值：
>
> 1.  根据定时器/计数器 确定M1M0、C/T'
>
> 如何设置计数器初值X，定时时间可以为0.1s/0.005s
>
> 1. 定时时间(us)=(2^16^-X) * 12 / 晶体振荡频率，解x即可
> 2.  X化为16禁止，前8位为TH0的值，后8位为TL0的值





## 串行口

> 并行通信与串行通信
>
> 串行：数据字节一位一位在一条传输线上逐个传送，一次传送一位
>
> 并行：多条数据线同时传送数据字节，每一位都需要一条传输线，还需要几条控制信号线 

> 串行通信的方式：
>
> 1. 异步通信：收发双方使用各自的始终控制，省区连接两者的一条同步时钟信号线
>     连接简单容易实现，但要求二者时钟尽可能一致
> 2. 同步通信：采用一个同步时钟，保持位同步关系，传送的字符之间不留间隙，传输数据的位之间距离均为“位间隔”的整数倍
>
> 通信类别：
>
> 1. 单工：只能单向 发送器向接收器发送
> 2. 半双工：可以双向，但是同时只能一个方向
> 3. 全双工：可以同时双向传送数据

### 串行口结构

接受、发送缓冲器SBUF：可同时收发数据，发送缓冲器只能写 ，接受缓冲器只能读

串行口控制寄存器SCON

1. SM0、SM1：控制工作方式
    1. 00 同步移位寄存器
    2. 01 8位异步收发
    3. 10 9位异步收发
    4. 11 9位异步收发
2. SM2 多机通信控制位
3. REN：
4. TB8：发送的第9位数据
5. RB8：接受的第9位数据
6. TI：
7. RI：

| SCON位 | SM0  | SM1  | REN  | TB8  | TB9  | TI                  | RI                  |      |
| ------ | ---- | ---- | ---- | ---- | ---- | ------------------- | ------------------- | ---- |
| 功能   |      |      |      |      |      | 发送中断标志        | 接受中断标志        |      |
|        |      |      |      |      |      | 1发送结束，软件清零 | 1接受结束，软件清零 |      |
|        |      |      |      |      |      |                     |                     |      |

特殊功能寄存器

波特率(bps)：每秒传送的二进制位

PCON

| PCON位 |      |      |      |      |      |      |      |      |
| ------ | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|        |      |      |      |      |      |      |      |      |
|        |      |      |      |      |      |      |      |      |
|        |      |      |      |      |      |      |      |      |





## 串行通信

双机通信接线：TXD接另一个RXD，RXD接另一个TXD，GND共同接1个地线

SM0SM1 = 01

> 串行通信的特点：数据字节的各位按一定顺序逐位传送。
> Ø优点：需要较少的通信线，通信距离较并行方式远
> Ø缺点：速度慢
> l并行通信的特点：数据字节的各位同时传送。
> Ø优点：速度快
> Ø缺点：需要较多的通信线，且传输距离短
>
> 串行通信的分类
> Ø 同步通信方式；
> Ø 异步通信方式。



### 串行通信种类

1) 同步串行通信方式
  l 同步串行通信通常用来传送连续的数据块；
  l 同步通信时字符与字符之间连续传输，不需要停顿，字符之间和字符内部各位之间都要进行同步；
  l 通信双方的同步可通过收发同步字符或同步时钟实现；
  l 发送数据中如有同步字符，则必须用其它字符或字符序列来代替它，这个过程称为字符的转义处理；
  l 同步串行通信方式常用于传输信息量大、传输速度高的场合；
  l 由于同步通信需要通过判断同步字符实现同步并对传输数据中包含的
  同步字符进行转义处理，因此其硬件设备较为复杂，成本较高。
2) 异步通信方式
  l 不需要固定的同步字符，发送多个数据时也不要求保持数据流的连续
  性。收发双方在传送每个数据时进行一次同步，且每组数据均以相同
  的帧格式进行传输。
  1) 串行通信的每一帧由起始位、数据位、校验位和停止位构成；
  2) 帧和帧之间可以连续发送，也可以用高电平间隔；
  3) 线路上没有数据传输时也保持高电平；
  4) 起始位：发送方发送一帧数据前首先发送的一位低电平信号；接收端一旦检测到一个高电平低电平的负跳变后，就开始做接收数据的准备。起始位的作用就是控制收发双方的同步，表示一帧数据传输的开始。
  5) 数据位：紧跟起始位之后的就是数据位。数据位是串行输出的待传送数据的各个二进制位。常见的数据位可以由5、6、7或8位二进制数据组成（现在基本都是8位数据位的方式）。串行数据在传送时从最低位（LSB）开始，例如对于8位数据，先发送D0，最后发送D7。
  6) 校验位：紧跟数据位之后的一位可选位。校验位的作用是对发送的数据进行校验。一般在串行通信中多采用奇偶校验位方式，即根据被传送的数据位中所有1的个数的奇偶性，选择校验位为
    1或0，保证数据位中1的个数和校验位中1的个数相加为奇数(奇校验方式)或偶数(偶校验方式)。串行通信中还可以选择固定校验位，如Space方式(固定为0)和Mark方式(固定为1)。参与串行通信双方应在通信前就约定使用一致的校验方式；
  7) 停止位：紧接校验位之后的是停止位，串行帧必须通过停止位
    来表示一帧的结束。停止位可以是1位、1.5位或2位，用固定的
    高电平表示。

> 异步串行通信中收发双方有两项设定必须保持一致：
> l 帧格式的设定必须一致。即一帧数据中的数据长度、校验方式以及停止位个数的设定都必须一致，才能互相通信；
> l 波特率的设定必须一致。串行通信实际上是按位传输数据的，只在每一帧开始时通过起始位同步。所以通信过程中每一位发送数据的持续时间必须和接收方的接收时间保持一致才能保证接收的正确。波特率就是衡量这个持续时间的单位，表示信息的传输速率，即单位时间内传输的信息位(bit)的个数，其单位是波特，1波特=1位/秒(1 bps)；
> l 串行通信控制器在接收数据时采用过采样的方式对线路进行扫描，判断线路的状态及串行通信帧中的各个功能位。过采样的速率一般是波特率的8、16或32倍，在数据位的中点采用三中取二的方式判决数据位的高低。

### 波特率计算

$$
f_{osc}：晶振频率\\
方式0: \frac {f_{osc}} {12}\\
方式2: \frac {2^{SMOD}f_{osc} } {64}\\
方式1/3: \frac {2^{SMOD}*T1的溢出率}{32}\\
T1的溢出率=\frac {f_{OSC}}{12* (256-TH1)}\\
$$

### 串行通信格式

方式0: D0~D7

方式1: 起始位+ D0~D7 +停止位

方式2/3：起始位 + D0~D8 + 停止位



方式1

数据位由TXD(P3.1)输出，发送一帧信息为10位（1位起始位0，8位数据位，1位停止位）

当CPU执行一条数据写SBUF指令，就启动发送

方式1接收时(REN = 1)，数据从RXD(P3.0)引脚输入

当检测到起始位的负跳变，就开始接收

方式2和方式3，根据通信协议由软件设置TB8，即启动发送/接收，TB8/RB8装入第9位数据

### 题目：单片机串口初始化

> [!ques]
>
> 单片机串口工作方式为1、波特率4800、波特率加倍、使用中断
>
> 编写配置程序/初始化程序
>
> [!ans]
> $$
> 4800=2^{SMOD}*f_{osc}/32*(256-X)*12
> $$
> 波特率加倍: SMOD=1，解得x为8位二进制数, 让TH1=TL1=x
>
> (一般x是好几万，对应16位二进制数，TH1为高8位，TL1为低8位)
>
> ```c
> void UartInit(){
>   SCON=0x50; // 工作方式1  (0101 0000)
>   TMOD=0x20; // 计数器工作方式2(串行通信可以不用。。)
>   PCON=0x80; // 波特率加倍
>   TH1=0xF3; // 计数器初值高8位
>   HL1=0xF3;
>   
>   ES=1; // 打开串口接收中断
>   EA=1; // 打开总中断
>   TR1=1; // 打开定时/计数器
> }
> ```
>
> 使用定时器1，TR1=1
> 定时器0，TR0=1																																																																			

### 数据差错检测

1). 奇偶校验法
l奇偶校验是一种最简单的检错码，它又可分为奇校验和偶校验两种。它是在n-1位信息码的后面附加一位校验码，使整个数据中的1(或0)的数目保持奇数个或偶数个；
l奇偶校验码能检测出一个码字内的奇数个错误，但不能发现偶数个错误，也不能纠正错误。因为每个码字中只有一个校验码，所以编码效率较高。奇偶校验法在干扰持续时间很短，差错常常为单个状态出现的状态下较为可靠。

2). 累加和校验法 
l累加和校验法一般用在对数据块进行校验的场合。它的编码方法是对各码字作异或累加或无进位算术累加，将最后的累加和放入数据块中一同传输。接收方采用同样的累加算法计算累加和，如果和发送方送达的累加和一致，说明通信无误。采用累加和校验码可以避免一部分奇偶校验法不能检测出的多位错误；

3). 循环冗余(Cyclic Redandence Check)校验法 
l又称CRC校验法，该算法把待校验的数据块看作一个很长的二进制数，用一个特定的数去除它，将余数作校验码附在数据块后一起发送；
l接收方收到数据块和校验码后，对其进行同样的运算，所得余数应相同，否则出错；
lCRC校验法对任何连续的、小于除数长度的通信错误可100%检出，可靠性很高；
l但是这种算法较为复杂，软件实现需要一定的系统开销，在通信速率要求较高的场合通常都通过硬件自动实现校验功能。
