## IO设备



| 按使用特性   | 按传输速率         | 按信息交换的单位               | 设备特性 |
| ------------ | ------------------ | ------------------------------ | -------- |
| 人机交互类   | 低速设备，键盘鼠标 | 块设备，磁盘<br />可寻址到字节 | 独占设备 |
| 存储设备     | 中速设备：打印机   | 字符设备，打印机<br />         | 共享设备 |
| 网络通信设备 | 高速设备：磁盘机   |                                | 虚拟设备 |

共享设备：一段时间内允许多个进程同时访问

## IO控制方式

1. 程序直接控制
2. 

| 控制方式     | 描述                                                         | 优缺点                                             |
| ------------ | ------------------------------------------------------------ | -------------------------------------------------- |
| 程序直接控制 | 每次读一个字的数据，cpu循环检查                              | 简单易于实现，CPU利用率低(cpu和io设备只能串行工作) |
| 中断驱动方式 | 允许IO设备主动中断CPU运行，并请求服务<br />IO中断属于**外中断** |                                                    |
| DMA方式      | 在IO设备和内存之间开辟直接数据交换通道                       | 解放CPU                                            |
| 通道方式     |                                                              | 比DMA方式效率高，CPU干预最少                       |

程序直接控制

1. 给IO模块发送读命令
2.  

中断驱动方式

1. 给IO模块发送读命令 
2. 数据进入寄存器后设备控制器向CPU发送中断信号
3. CPU检查输入过程是否出错，从IO模块读取，向存储器写入字

DMA方式

1. 

## IO软件的层次结构

1. 用户层IO软件
2. 设备独立性软件
3. 设备驱动程序
4. 中断处理程序
5. 硬件

| 层次                                        | 描述                                                         |
| ------------------------------------------- | ------------------------------------------------------------ |
| 用户层IO软件                                | 实现与用户交互的接口                                         |
| 与设备无关的操作系统IO软件 / 设备独立性软件 | 用于实现用户程序和设备驱动器的统一接口、设备命令/保护/分配释放，<br />**设备独立性**：应用程序**独立于具体使用的物理设备**，与其无关，使用设备具有透明性 |
| IO设备驱动程序                              | 与硬件直接相关，                                             |
| IO中断处理程序                              | 保存被中断进程的CPU环境，转入相应的中断处理程序进行处理，处理完并恢复现场，返回被中断进程 |
| 硬件设备                                    | 包括机械部件和电子部件                                       |



## Spooling技术

1. 提高IO**速度**
2. 将独占设备改造成**共享设备**
3. 实现了**虚拟设备**功能

|            |                                                              |      |
| ---------- | ------------------------------------------------------------ | ---- |
| 输出井     | 位于磁盘的一个固定区域                                       |      |
| 输入缓冲区 | 暂存输入数据，之后传送到输入井                               |      |
| 输出缓冲区 | 暂存输出井的数据，之后传送到输出设备                         |      |
| 输入进程   | 将数据从输入井→输入缓冲区→输入井，当CPU需要输入数据时，将数据读入内存 |      |
| 输出进程   | 将输出数据从内存→输出井→输出缓冲区→输出设备                  |      |

实例：共享打印机

1. 输出进程在输出井中申请空闲磁盘块区，将打印的数据传入输出井
2. 输出进程为用户进程申请空白的用户请求打印表，填入打印数据，挂载到请求打印队列
3. 

## 设备分配和回收

根据用户的IO请求分配设备

设备分配的数据结构：

1. DCT设备控制表
2. COCT控制器控制表
3. CHCT：通道控制表

| 设备分配方式 |                                    |      |
| ------------ | ---------------------------------- | ---- |
| 静态分配     |                                    |      |
| 动态分配     | 根据需要进行分配，一旦用完立即释放 |      |
|              |                                    |      |



| 设备分配算法 |      |      |
| ------------ | ---- | ---- |
| 先请求先分配 |      |      |
| 优先级高     |      |      |
|              |      |      |



### 设备分配安全性

安全：设备分配过程中防止发生进程死锁

分配共享设备时不会引起进程死锁

不安全的分配方式：

## 磁盘结构

> 磁盘：表面涂有磁性物质的金属构成的圆形盘片，通过固定磁头读取数据，磁盘高速旋转 
>
> 磁道：盘面上的数据存储在的一组同心圆，磁道又分为几百个扇区(盘块)，每个扇区存储512B
>
> 扇区：头、数据区域(512B)、尾
>
> 磁盘驱动器：磁盘安装的位置，具有磁头臂，主轴，输入输出的电子设备
>
> 盘面=2*盘片
> 每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心距离相等且一起移动

## 磁盘调度算法

多个请求读写磁盘，操作系统调度

磁盘读写操作时间

1. 寻道时间：磁头移动到指定磁道的时间，包括跨越n条磁道和启动磁臂的时间s $T=m*n + s$
2. 延迟时间：磁头定位到磁道的扇区的时间，磁盘旋转速度为r $T=1/2r$
3. 传输时间，读写数据的时间，取决于字节数b和磁盘旋转速度 $T=b/rN，N为一个磁道上的字节数$

磁盘调度算法

1. FCFS
2. SSTF最短寻找时间优先：调度最近的磁道
   缺点：不保证寻道时间短，会产生饥饿现象(某个区域请求频繁，远离该区域的请求得不到响应)
3. SCAN扫描算法(电梯调度算法)：在SSTF基础上规定磁头运动方向为当前磁头的移动方向，直到末尾(不管末尾是否有请求都要走)
   缺点：不利于远离磁头一端的访问
4. C-SCAN：在SCAN基础上，回返时快速移动到起始端，因此磁头接受请求时的访问方向是单向的
5. LOCK调度和C-LOCK调度：无需到达最远端，查看前方是否有请求，没有就回返

> [!tip]
>
> 指标平均寻找长度：平均磁道数计算
>
> 平均寻找长度：磁头移动的平均磁道数
>
> 1. 列出移动磁道的顺序
> 2. 依次计算差值累加计算

### 题目：磁盘调度算法

学校题目里的电梯调度算法好像是有lock的

| 当前位置       | 125→149 |      |      |      |         |      |      |      |      |      |      |
| -------------- | ------- | ---- | ---- | ---- | ------- | ---- | ---- | ---- | ---- | ---- | ---- |
| 磁道请求序列   | 88      | 147  | 95   | 177  | 94      | 150  | 102  | 175  | 138  |      |      |
| 先来先服务算法 | 149     | 88   | 147  | 95   | 177     | 94   | 150  | 102  | 175  | 138  |      |
| 电梯调度算法   | 149     | 150  | 175  | 177  | ~~200~~ | 147  | 138  | 102  | 95   | 94   | 88   |

1. 先来先服务：61+59+52+82+83+56+48+73+37
2. 电梯：177-149+177-88=117

| 当前位置             | 100  |      |      |      |      |      |      |      |      |      |
| -------------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 磁道请求序列         | 55   | 58   | 39   | 18   | 90   | 160  | 150  | 38   | 180  |      |
| 最短查找时间优先算法 | 100  | 90   | 58   | 55   | 39   | 38   | 18   | 150  | 160  | 180  |
|                      |      |      |      |      |      |      |      |      |      |      |

总磁道移动数：

1. 100-18+180-18=244

## 磁盘管理

磁盘初始化

1. 物理格式化
2. 磁盘分区，每个分区由若干柱面组成
3. 逻辑格式化，创建文件系统

引导块: 计算机启动时运行初始化程序，初始化cpu寄存器设备控制器内存，然后启动操作系统，

坏块：无法正常使用的扇区，硬件故障
备用扇区：用于替换坏块