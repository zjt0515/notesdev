## 文件，文件系统 

> 文件：以硬盘为载体，存储再计算机上的信息集合，计算机以进程为基本单位进行资源调度分配，用户以文件为基本单位进行输入输出
>
> 文件属性：名称/类型/位置/大小/保护/时间/用户标识
>
> 文件操作：增删改查、重定位和截断
>
> 文件分类：
>
>    | Unix     | 按逻辑结构          |      |
>    | -------- | ------------------- | ---- |
>    | 普通文件 | 结构文件/记录式文件 |      |
>    | 目录文件 | 无结构文件/流式文件 |      |
>    | 特殊文件 |                     |      |
>
>    

### 文件操作

创建文件的过程

1. 在文件系统中找到空间
2. 在目录中新建条目，记录文件名称、位置...

写文件

1. 执行一个系统调用，传入文件名称和写入内容
2. 系统搜索目录查找位置，维护一个写位置的指针

读文件

1. 执行一个系统调用，传入文件名称和要读入的文件块的内存位置
2. 同上

文件重定位

1. 按某条件搜索目录，将当前文件位置设为给定值，不会读写文件

删除文件

1. 搜索目录，删除文件的目录项，删除文件控制块，释放文件关联的内存缓冲区
2. 回收占用的存储空间

截断文件

1. 允许文件所有属性不变，然后删除文件内容

打开/关闭：open 和 close系统调用

### 文件系统的层次结构

| 层次                                                         | 用途                                                         |      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ---- |
| 用户                                                         | 处理系统调用                                                 |      |
| 文件目录                                                     | 根据文件路径找到响应的索引结点，其他目录管理工作             |      |
| 存取控制模块                                                 | 验证访问权限，文件保护                                       |      |
| 逻辑文件系统和文件信息缓冲区                                 | 将记录号转换为逻辑地址                                       |      |
| 物理文件系统                                                 | 将文件逻辑地址转换为实际的物理地址                           |      |
| 辅助分配模块+负责文件存储空间的管理(分配和回收存储空间)+设备管理模块 | 直接与硬件交互，如分配+ 启动释放设备，分配设备缓冲区，磁盘调度， |      |

### 文件逻辑结构

1. 流式文件
2. 记录式文件
    1. 顺序文件
    2. 索引文件
    3. 索引顺序文件
    4. 记录式文件



### 文件物理结构

> 文件如何分配磁盘块

1. 连续分配
2. 链接分配
   1. 隐式链接
   2. 显式链接
3. 索引分配
   1. 一级索引
   2. 多级索引
   3. 混合索引

| 分配方式 |                                                              | 优缺点                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连续分配 |                                                              | 支持顺序/随机访问; 速度快<br />容易产生外部碎片，磁盘利用率低; 需要事先知道文件长度，无法实行文件动态增长 |
| 链接分配 | 隐式链接：目录项记录文件名、对应的起始和结束块号。(除了最后一个)每个盘块都有指向下一盘快的指针<br />显式链接：FAT表存放指向下一个盘块的指针，链接文件的各盘块指针显式存放在FAT | 无需连续的存储空间; 无外部碎片; 无需事先知道文件长度; 便于文件增删改<br />隐式链接：只支持顺序访问; 可靠性差<br />显式链接：FAT占用额外内存空间; 不支持告诉随机存取 |
| 索引分配 | 每个文件建立索引表，记录文件的所有盘块记录                   |                                                              |

> 
>
> 索引分配的索引表：
>
> | 文件名 | 索引块 |
> | ------ | ------ |
> | A      | 20     |
> | B      | 21     |
>
> 

###  题目：求fat表大小

> [!ques]
>
> 磁盘块大小1K，540M/1.2G的硬盘fat占用多大
>
> [!ans]
>
> 1. 磁盘块数量=540M/1K=540K
> 2. 540K < 1024K = 2^20^



### 题目：求索引分配的单个文件长度

> [!tip]
>
> 索引分配时，单个文件长度的决定因素：
>
> 1. 地址项个数
> 2. 间接地址级数
> 3. 文件块大小

> [!ques]
>
> 

## 文件目录管理 

> 目录管理的工作

文件控制块FCB：存放控制文件需要的各种信息的数据结构，实现按名存取

一个FCB就是一个文件目录项，创建新文件，系统分配一个FCB并存放在文件目录中，成为目录项

FCB的内容信息：文件名/物理位置/逻辑结构/物理结构/存取控制信息

目录结构： 

1. 单级目录结构
2. 两级目录结构，文件目录和用户文件目录
3. 多级目录结构（树形目录结构）
4. 无环图目录结构：实现文件共享



> [!ques]
>
> 物理块大小4KB，物理块号占4B，两级索引结构下，允许最大文件长度
>
> 1. 4KB/4B=1024
> 2. 两级索引功能存储1024*1024个块号
> 3. 最大文件长度=1024*1024 *4KB=4GB

### 索引节点

索引节点：存放除了文件名之外的所有信息
目录项只需包含文件，索引结点指针，减少目录项长度

> [!ques]
>
> 盘块大小1KB，FCB大小64B，目录中包含640个文件
>
> 1. 无索引节点，平均访问盘块数
> 2. 有索引节点，每个目录项16B，平均访问盘块数
>
> [!ans]
>
> 1. 每个盘块能存放1K/64=16个FCB，对应16个文件，640/16=40，需要40个盘块
> 2. 平均访问盘块数=40/2=20
>
> 1. 有索引节点每个盘块存64个目录项，对应64个文件
> 2. 平均访问盘块数=640/64/2=5



## 外存管理

1. 空闲表法
2. 空闲链表法
3. 位示图法
4. 成组链接法

| 外存管理方法 | 描述                     | 优缺点 |
| ------------ | ------------------------ | ------ |
|              |                          |        |
|              |                          |        |
|              |                          |        |
| 位示图       | 二进制位表示盘块使用情况 |        |



## 文件共享和保护

文件共享

### 基于索引结点共享（硬链接）

文件共享索引节点

索引结点中设置链接计数变量count：标识链接到该结点的用户目录项数
例如，count=2表示2个用户共享文件

一个用户删除该文件：用户目录中与该文件对应的目录项删除，count--
count>0，不能删除文件数据

### 基于符号链的共享方式（软链接）

链接父目录，类似快捷方式

### 口令保护

为文件设置一个口令，系统验证口令，实现开销小，口令存放在FCB/索引结点中不安全

### 加密保护

安全性高，加密解密有开销

### 访问控制

用一个访问控制表ACL用户对文件的访问权限

实现灵活

## 磁盘结构

> 磁盘：表面涂有磁性物质的金属构成的圆形盘片，通过固定磁头读取数据，磁盘高速旋转 
>
> 磁道：盘面上的数据存储在的一组同心圆，磁道又分为几百个扇区(盘块)，每个扇区存储512B
>
> 扇区：头、数据区域(512B)、尾，是磁盘**访问的最小单位**
>
> 磁盘驱动器：磁盘安装的位置，具有磁头臂，主轴，输入输出的电子设备
>
> 盘面=2*盘片
> 每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心距离相等且一起移动

## 磁盘调度算法

多个请求读写磁盘，操作系统调度

磁盘读写操作时间

1. 寻道时间：磁头移动到指定磁道的时间，包括跨越n条磁道和启动磁臂的时间s $T=m*n + s$
2. 延迟时间：磁头定位到磁道的扇区的时间，磁盘旋转速度为r $T=1/2r$
3. 传输时间，读写数据的时间，取决于字节数b和磁盘旋转速度 $T=b/rN，N为一个磁道上的字节数$

磁盘调度算法

1. FCFS
2. SSTF最短寻找时间优先：调度最近的磁道
   缺点：不保证寻道时间短，会产生饥饿现象(某个区域请求频繁，远离该区域的请求得不到响应)
3. SCAN扫描算法(电梯调度算法)：在SSTF基础上规定磁头运动方向为当前磁头的移动方向，直到末尾(不管末尾是否有请求都要走)
   缺点：不利于远离磁头一端的访问
4. C-SCAN：在SCAN基础上，回返时快速移动到起始端，因此磁头接受请求时的访问方向是单向的
5. LOCK调度和C-LOCK调度：无需到达最远端，查看前方是否有请求，没有就回返

> [!tip]
>
> 指标平均寻找长度：平均磁道数计算
>
> 平均寻找长度：磁头移动的平均磁道数
>
> 1. 列出移动磁道的顺序
> 2. 依次计算差值累加计算

## 磁盘管理

磁盘初始化

1. 物理格式化
2. 磁盘分区，每个分区由若干柱面组成
3. 逻辑格式化，创建文件系统

引导块: 计算机启动时运行初始化程序，初始化cpu寄存器设备控制器内存，然后启动操作系统，

坏块：无法正常使用的扇区，硬件故障
备用扇区：用于替换坏块
