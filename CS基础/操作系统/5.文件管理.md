## 文件，文件系统 

> 文件：以硬盘为载体，存储再计算机上的信息集合，计算机以进程为基本单位进行资源调度分配，用户以文件为基本单位进行输入输出
>
> 文件属性：名称/类型/位置/大小/保护/时间/用户标识
>
> 文件操作：增删改查、重定位和截断
>
> 文件分类：
>
> | Unix                                        | 按逻辑结构              |      |
> | ------------------------------------------- | ----------------------- | ---- |
> | 普通文件                                    | 结构文件/**记录式**文件 |      |
> | **目录**文件: 由文件控制块FCB组成的有序集合 | 无结构文件/**流式**文件 |      |
> | 特殊文件                                    |                         |      |
>
> 文件系统
>
> 主要功能：实现按名存取



> [!note]
>
> 文件管理功能：
>
> 1. 提供增删改查文件的操作命令和API
> 2. 在系统控制下共享文件
> 3. 对文件存储空间的管理
> 4. 转存和恢复文件
> 5. 可靠的文件安全保护措施

### 文件操作

创建文件的过程

1. 在文件系统中找到空间
2. 在目录中新建条目，记录文件名称、位置...

写文件

1. 执行一个系统调用，传入文件名称和写入内容
2. 系统搜索目录查找位置，维护一个写位置的指针

读文件(读之前首先请求系统执行打开文件)

1. 执行一个系统调用，传入文件名称和要读入的文件块的内存位置
2. 同上

文件重定位

1. 按某条件搜索目录，将当前文件位置设为给定值，不会读写文件

删除文件

1. 搜索目录，删除文件的目录项，删除文件控制块，释放文件关联的内存缓冲区
2. 回收占用的存储空间

截断文件

1. 允许文件所有属性不变，然后删除文件内容

打开/关闭：open 和 close系统调用

### 文件系统的层次结构

| 层次                                                         | 用途                                                         |      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ---- |
| 用户                                                         | 处理系统调用                                                 |      |
| 文件目录                                                     | 根据文件路径找到响应的索引结点，其他目录管理工作             |      |
| 存取控制模块                                                 | 验证访问权限，文件保护                                       |      |
| 逻辑文件系统和文件信息缓冲区                                 | 将记录号转换为逻辑地址                                       |      |
| 物理文件系统                                                 | 将文件逻辑地址转换为实际的物理地址                           |      |
| 辅助分配模块+负责文件存储空间的管理(分配和回收存储空间)+设备管理模块 | 直接与硬件交互，如分配+ 启动释放设备，分配设备缓冲区，磁盘调度， |      |

### 文件逻辑结构

1. **流式**文件：基本单位为字节
2. **记录式**文件
    1. 顺序文件，适合放在磁带上
    2. 索引文件
    3. 索引顺序文件
    4. 记录式文件



### 文件物理结构

> 文件如何分配磁盘块
>
> 在**外部设备**上的文件组织形式

1. 连续分配(**顺序**结构)
2. 链接分配(**链接**结构)
   1. 隐式链接
   2. 显式链接
3. **索引**分配
   1. 一级索引
   2. 多级索引
   3. 混合索引

| 分配方式          |                                                              | 优缺点                                                       |
| ----------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连续分配/顺序结构 |                                                              | 支持顺序/随机访问，顺序存取容易; **速度快**<br />容易产生外部碎片，磁盘利用率低; **需要事先知道文件长度**，无法实行文件动态增长 |
| 链接分配          | 隐式链接：目录项记录文件名、对应的起始和结束块号。(除了最后一个)每个盘块都有指向下一盘快的指针<br />显式链接：FAT表存放指向下一个盘块的指针，链接文件的各盘块指针显式存放在FAT | 无需连续的存储空间; 无外部碎片; 无需事先知道文件长度; 便于文件增删改<br />隐式链接：只支持顺序访问; 可靠性差; 不便于直接存取<br />显式链接：FAT占用额外内存空间; 不支持告诉随机存取；不便于直接存取 |
| 索引分配          | 每个文件建立索引表，记录文件的所有盘块记录                   | 适合随机访问，易于文件拓展                                   |

#### 链接结构:

每组最后一个盘块存放下一组的空闲盘块数+空闲盘块号

空闲盘块栈：存放当前可用的一组空闲盘块号

> [!ques]

隐式链接相关题目

> [!ques]
>
> 隐式链接，逻辑记录大小100B，盘块大小512B，文件目录项已读入内存，请求修改22号逻辑记录的访问次数
>
> 1. 512/100=5……12
> 2. 22/5，向上取整，存在5号盘块中，链接分配需要顺序查找5次
> 3. 已读入内存，则已知对应磁盘位置，还需访问磁盘1次，5+1=6
>
> 某文件有 L~1~ - L~8~ 的 8 个记录, 采用隐式链接分配, 每个记录和链接指针占一个盘块, 主存中的磁盘缓冲区的大
> 小等于磁盘块的大小. 若该文件的目录已读入内存, 求在 L~5~ 和 L~6~ 间插入一个记录 L~x~(已在内存中) 的读盘次数和写盘次数. 
>
> 1. 一次读L1到L5，读盘5次
> 2. 将Lx写入空闲盘块，该盘指针指向L6，写盘1次
> 3. 修改L5盘块指针指向Lx，写盘1次

#### 索引结构

> 索引分配的索引表：
>
> | 文件名 | 索引块 |
> | ------ | ------ |
> | A      | 20     |
> | B      | 21     |

>  [!ques]
>
> 混合索引方式，每个文件的索引表规定为13个索引项，每项4个字节，j记录一个存放文件信息的物理块号。**前面10项**存放文件信息的物理块号，叫直接寻址。假定物理块的大小是4KB，如果文件大于10块，则利用第11项指向一个物理块，该块中最多可放1K个存放文件信息的物理块的块号，这种方式是一次间接寻址。大型文件还可以利用第12和13项作二次和三次间接寻址。
>
> 请画出混合索引文件结构图，并回答直接寻址可以表示多大的文件？一次间接寻址，可以表示多大的文件？二次和三次间接寻址分别可以表示多大的文件？

混合索引题目

> [!ques]
>
>   某 OS 采用混合索引方式为文件分配外存, 索引节点含 13  个地址项, 其中直接地址 10 个, 一次间接地址  1个, 二次间接地址1个, 三次间接地址 1 个. 设盘块大小为 4KB  , 每个盘块号占 4B  . 求存储一个 5GB  的文件实际占用磁盘空间的大小.
>
> 1. 各级索引支持的最大文件大小
>     1. 直接索引=10*4KB
>     2. 一级索引=1024*4KB
>     3. 二级索引=1024^2^*4KB
>     4. 三级索引=1024^3^*4KB
> 2. 文件本身占用块数=5GB/4KB
> 3. 文件占用的各级索引块数

###  题目：求fat表大小

> [!ques]
>
> 磁盘块大小1K， 540M硬盘，求文件分配表FAT需要占用的存储空间
>
> 1.2G的硬盘，又需要多少
>
> 1. 求盘块个数：540M/1k = 540k
> 2. 求该个数需要用多少二进制位表示：512k < 540k < 1024k = 2^20^，即需要20个bit，即每个表项占用2.5字节
> 3. 表大小=盘块数*指数= 20bit * 540k = 2.5MB * 540k = 1350kB
>
> [!ans]
>
> 540M: 1350k
>
> 1.2G: 3.6M (1M<1.2M<2M=2^21^->2^24^)???



### 题目：求索引分配的单个文件长度

> [!tip]
>
> 索引分配时，单个文件长度的决定因素：
>
> 1. 地址项个数
> 2. 间接地址级数
> 3. 文件块大小

> [!ques]
>
> 

## 文件目录管理 

目录管理功能 

1. 按名存取
2. 提高检索速度
3. 文件共享
4. 允许文件重名

> 文件控制块FCB：存放控制文件需要的各种信息的数据结构，实现按名存取
>
> 文件目录：FCB的有序集合，，一个FCB对应一个目录项，对应一个文件
>
> 创建新文件，系统分配一个FCB并存放在文件目录中，成为目录项
>
> FCB的内容信息
>
> 1. 文件名、拓展名
> 2. 物理位置
> 3. 逻辑结构
> 4. 物理结构
> 5. 存取控制信息



### 文件目录结构： 

1. 单级目录结构
2. 两级目录结构，**主目录和用户文件目录**
3. 多级目录结构（树形目录结构）
4. 无环图目录结构：实现文件共享

| 目录结构       | 描述 | 优点 | 缺点                                    |
| -------------- | ---- | ---- | --------------------------------------- |
| 单级目录结构   |      |      | 查找速度慢，不允许重名 难以实现文件共享 |
| 两级目录结构   |      |      |                                         |
| 多级目录结构   |      |      |                                         |
| 无环图目录结构 |      |      |                                         |



> [!note]
>
> 单级目录的优缺点：
>
> 1. 查找速度慢
> 2. 不允许重名
> 3. 难以实现文件共享

> [!tip]
>
> 各级索引支持的最大文件大小：
>
> 1. 求一个物理块能够存放多少各盘块号: $x=\frac {盘块大小}{盘块号大小}$
> 2. 直接索引最大文件大小$=直接地址数目*盘块大小$
> 3. 1级索引最大文件大小$=x*盘块大小$
> 4. 2级索引最大文件大小$=x^2*盘块大小$
> 5. 3级索引最大文件大小$=x^3*盘块大小$

> [!ques]
>
> 物理块大小4KB，物理块号占4B，两级索引结构下，允许最大文件长度
>
> 1. 4KB/4B=1024
> 2. 两级索引功能存储1024*1024个块号
> 3. 最大文件长度=1024*1024 *4KB=4GB

### 索引节点

索引节点：存放除了文件名之外的所有信息
目录项只需包含文件，索引结点指针，减少目录项长度

> [!tip]
>
> n个文件的平均访问盘块数 ：n个文件对应的盘块数/2 

> [!ques]
>
> 盘块大小1KB，FCB大小64B，目录中包含640个文件
>
> 1. 无索引节点，平均访问盘块数
> 2. 有索引节点，每个目录项16B，平均访问盘块数
>
> [!ans]
>
> 1. 每个盘块能存放1K/64=16个FCB，对应16个文件，640/16=40，需要40个盘块
> 2. 平均访问盘块数=40/2=20
>
> 1. 有索引节点每个盘块存64个目录项，对应64个文件，640/64 = 10需要10个盘块
> 2. 平均访问盘块数=10/2=5



## 外存管理

1. 空闲表法
2. 空闲链表法
3. 位示图法
4. 成组链接法

| 外存管理方法 | 描述                                                  | 优缺点 |
| ------------ | ----------------------------------------------------- | ------ |
| 空闲表法     |                                                       |        |
| 空闲链表法   |                                                       |        |
| 位示图       | 1个二进制位表示1个盘块使用情况，一个簇/盘块使用1个bit |        |
| 成组链接法   |                                                       |        |

> 10GB磁盘，簇大小4KB，采用位视图法，求存放位示图所需的簇数
>
> 10GB/4KB=2.5M -> 2.5Mbit = 320KB/4KB=80
>
> 注意从bit转到B的单位转化

## 文件共享

### 基于索引结点共享（硬链接）

文件共享索引节点

索引结点中设置链接计数变量count：标识链接到该结点的用户目录项数
例如，count=2表示2个用户共享文件

一个用户删除该文件：用户目录中与该文件对应的目录项删除，count--
count>0，不能删除文件数据

### 基于符号链的共享方式（软链接）

链接父目录，类似快捷方式



> [!note]
>
> 影响文件安全的因素及措施
>
> 1. 人为因素：存取控制机制
> 2. 系统故障：系统容错技术
> 3. 自然：后备系统



## 文件保护

`- rwx r-x ---`

1. 文件类型
   1. -：普通文件
2. 文件组的权限
3. 同组用户的权限
4. 不同组用户的权限

### 口令保护

为文件设置一个口令，系统验证口令，实现开销小，口令存放在FCB/索引结点中不安全

### 加密保护

安全性高，加密解密有开销

### 访问控制

用一个访问控制表ACL用户对文件的访问权限

实现灵活

## 磁盘结构

> 磁盘：表面涂有磁性物质的金属构成的圆形盘片，通过固定磁头读取数据，磁盘高速旋转 
>
> 磁道：盘面上的数据存储在的一组同心圆，磁道又分为几百个扇区(盘块)，每个扇区存储512B
>
> 扇区：头、数据区域(512B)、尾，是磁盘**访问的最小单位**
>
> 磁盘驱动器：磁盘安装的位置，具有磁头臂，主轴，输入输出的电子设备
>
> 盘面=2*盘片
> 每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心距离相等且一起移动

## 磁盘调度算法

多个请求读写磁盘，操作系统调度

磁盘读写操作时间

1. 寻道时间：磁头移动到指定磁道的时间，包括跨越n条磁道和启动磁臂的时间s $T=m*n + s$
2. 延迟时间：磁头定位到磁道的扇区的时间，磁盘旋转速度为r $T=1/2r$
3. 传输时间，读写数据的时间，取决于字节数b和磁盘旋转速度 $T=b/rN，N为一个磁道上的字节数$

磁盘调度算法

1. FCFS
2. SSTF最短寻找时间优先：调度最近的磁道
   缺点：不保证寻道时间短，会产生饥饿现象(某个区域请求频繁，远离该区域的请求得不到响应)
3. SCAN扫描算法(电梯调度算法)：在SSTF基础上规定磁头运动方向为当前磁头的移动方向，直到末尾(不管末尾是否有请求都要走)
   缺点：不利于远离磁头一端的访问
4. C-SCAN：在SCAN基础上，回返时快速移动到起始端，因此磁头接受请求时的访问方向是单向的
5. LOCK调度和C-LOCK调度：无需到达最远端，查看前方是否有请求，没有就回返

> [!tip]
>
> 指标平均寻找长度：平均磁道数计算
>
> 平均寻找长度：磁头移动的平均磁道数
>
> 1. 列出移动磁道的顺序
> 2. 依次计算差值累加计算

## 磁盘管理

磁盘初始化

1. 物理格式化
2. 磁盘分区，每个分区由若干柱面组成
3. 逻辑格式化，创建文件系统

引导块: 计算机启动时运行初始化程序，初始化cpu寄存器设备控制器内存，然后启动操作系统，

坏块：无法正常使用的扇区，硬件故障
备用扇区：用于替换坏块
